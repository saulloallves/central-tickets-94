import { serve } from "https://deno.land/std@0.177.0/http/server.ts";
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { loadZAPIConfig } from "../_shared/zapi-config.ts";
import { isDFCOMBusinessHours } from "../_shared/business-hours.ts";

const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
};

serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

    try {
      const body = await req.json();
      console.log("üì© Webhook DFCom recebido:", body);

      // Verificar modo silencioso (para integra√ß√£o com Typebot)
      const silentMode = body?.silent_mode === true;
      console.log(`üîá Silent Mode: ${silentMode}`);

      // Extrai o phone do grupo
      const phone = body?.body?.phone || body?.phone || body?.participantPhone;
    if (!phone) {
      return new Response(JSON.stringify({ error: "Telefone n√£o encontrado no payload" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 400,
      });
    }

    // Verificar se est√° dentro do hor√°rio de atendimento DFCOM (estendido at√© 18h30)
    if (!isDFCOMBusinessHours()) {
      console.log("‚è∞ Fora do hor√°rio de atendimento DFCOM - redirecionando para autoatendimento");
      
      const mensagemForaHorario = "‚ùå *Agora estamos fora do hor√°rio de atendimento.*\n\n‚è∞ Nosso time DFCom atende de segunda a s√°bado, das *8h30 √†s 18h30.*\n\nüìù Voc√™ pode abrir um ticket agora mesmo. Sua solicita√ß√£o ser√° registrada e respondida pela equipe assim que poss√≠vel.";
      
      if (!silentMode) {
        // Carrega configura√ß√µes Z-API para enviar mensagem de fora do hor√°rio
        const { instanceId, instanceToken, clientToken, baseUrl } = await loadZAPIConfig();
        
        const outOfHoursPayload = {
          phone,
          message: mensagemForaHorario,
          buttonList: {
            buttons: [
              {
                id: "autoatendimento_ticket",
                label: "üìù Abrir um ticket agora"
              }
            ]
          }
        };

        const zapiUrl = `${baseUrl}/instances/${instanceId}/token/${instanceToken}/send-button-list`;
        console.log(`üì§ Enviando mensagem de fora do hor√°rio para Z-API: ${zapiUrl.replace(instanceToken, '****')}`);

        const res = await fetch(zapiUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Client-Token": clientToken,
          },
          body: JSON.stringify(outOfHoursPayload),
        });

        const data = await res.json();
        console.log("üì§ Mensagem de fora do hor√°rio enviada:", data);
      }

      return new Response(JSON.stringify({ 
        success: true, 
        fora_do_horario: true,
        mensagem_gerada: mensagemForaHorario
      }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 200,
      });
    }

    // Conecta no Supabase atual (para chamados)
    const supabase = createClient(
      Deno.env.get("SUPABASE_URL"),
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY"),
    );

    // Conecta no Supabase externo (para unidades)
    const externalSupabase = createClient(
      Deno.env.get("EXTERNAL_SUPABASE_URL"),
      Deno.env.get("EXTERNAL_SUPABASE_SERVICE_KEY"),
    );

    // 1. Buscar atendente DFCom dispon√≠vel (necess√°rio antes de criar o chamado)
    const { data: atendenteDFCom, error: atendenteError } = await supabase
      .from('atendentes')
      .select('id, nome')
      .eq('tipo', 'dfcom')
      .eq('status', 'ativo')
      .eq('ativo', true)
      .maybeSingle();

    if (atendenteError || !atendenteDFCom) {
      console.error("‚ùå Atendente DFCom n√£o encontrado:", atendenteError);
      return new Response(JSON.stringify({ error: "Atendente DFCom n√£o encontrado" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 500,
      });
    }
    console.log("‚úÖ Atendente DFCom encontrado:", atendenteDFCom);

    // 2. Busca a unidade correspondente ao grupo no projeto externo
    const { data: unidadeExterna, error: unidadeError } = await externalSupabase
      .from("unidades")
      .select("id, grupo, codigo_grupo, concierge_name, concierge_phone")
      .eq("id_grupo_branco", phone)
      .limit(1)
      .single();

    if (unidadeError || !unidadeExterna) {
      console.error("‚ùå Unidade externa n√£o encontrada:", unidadeError);
      return new Response(JSON.stringify({ error: "Unidade n√£o encontrada" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 404,
      });
    }
    console.log("‚úÖ Unidade externa encontrada:", unidadeExterna);

    // 3. Buscar unidade local (atendente_unidades) usando codigo_grupo
    const { data: unidadeLocal, error: unidadeLocalError } = await supabase
      .from("atendente_unidades")
      .select("id, grupo, codigo_grupo, atendente_id")
      .eq("codigo_grupo", unidadeExterna.codigo_grupo)
      .eq("ativo", true)
      .maybeSingle();

    if (unidadeLocalError || !unidadeLocal) {
      console.error("‚ùå Unidade local n√£o encontrada:", unidadeLocalError);
      return new Response(JSON.stringify({ error: "Unidade local n√£o encontrada" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 404,
      });
    }
    console.log("‚úÖ Unidade local encontrada:", unidadeLocal);

    // 4. Verificar se j√° existe um atendimento ativo DFCom para este telefone
    const { data: chamadoExistente, error: verificacaoError } = await supabase
      .from("chamados")
      .select("id, status, criado_em")
      .eq("telefone", phone)
      .eq("unidade_id", unidadeLocal.id)
      .eq("tipo_atendimento", "dfcom")
      .in("status", ["em_fila", "em_atendimento"])
      .maybeSingle();

    if (verificacaoError) {
      console.error("‚ùå Erro ao verificar chamados existentes:", verificacaoError);
    }

    // Se j√° existe um atendimento DFCom ativo, n√£o criar novo
    if (chamadoExistente) {
      console.log("‚ö†Ô∏è Atendimento DFCom j√° existe:", chamadoExistente);

      // Buscar posi√ß√£o na fila GLOBAL se estiver em fila ou em atendimento
      let posicao = null;
      if (chamadoExistente.status === "em_fila" || chamadoExistente.status === "em_atendimento") {
        const { data: fila } = await supabase
          .from("chamados")
          .select("id, criado_em")
          .in("status", ["em_fila", "em_atendimento"])
          .eq("tipo_atendimento", "dfcom")
          .order("criado_em", { ascending: true });

        if (fila) {
          posicao = fila.findIndex((c) => c.id === chamadoExistente.id) + 1;
        }
      }

      // Carrega configura√ß√µes Z-API
      const { instanceId, instanceToken, clientToken, baseUrl } = await loadZAPIConfig();
      const zapiUrl = `${baseUrl}/instances/${instanceId}/token/${instanceToken}`;

      async function enviarZapi(endpoint: string, payload: any) {
        try {
          const res = await fetch(`${zapiUrl}/${endpoint}`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "Client-Token": clientToken },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          console.log("üì§ Enviado:", endpoint, data);
        } catch (err) {
          console.error("‚ùå Erro ao enviar Z-API:", err);
        }
      }

      // Enviar mensagem adequada baseada no status
      let mensagem = "";
      
      if (chamadoExistente.status === "em_fila") {
        mensagem = `‚è≥ *Voc√™ j√° possui um atendimento DFCom na fila*\n\nüìä Sua posi√ß√£o: *#${posicao}*\n\nPor favor, aguarde sua vez. Voc√™ receber√° uma mensagem quando for atendido.`;
        
        if (!silentMode) {
          await enviarZapi("send-text", {
            phone,
            message: mensagem,
          });
        }
      } else if (chamadoExistente.status === "em_atendimento") {
        mensagem = `üë• *Voc√™ j√° est√° sendo atendido pela equipe DFCom*\n\nVoc√™ j√° possui um atendimento t√©cnico em andamento com nossa equipe.\n\nContinue a conversa√ß√£o aqui mesmo.`;
        
        if (!silentMode) {
          await enviarZapi("send-text", {
            phone,
            message: mensagem,
          });
        }
      }

      return new Response(JSON.stringify({ 
        success: true, 
        atendimento_existente: true,
        chamado: chamadoExistente,
        posicao,
        mensagem_gerada: mensagem
      }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 200,
      });
    }

    // 5. Criar novo chamado DFCom
    const { data: chamado, error: chamadoError } = await supabase
      .from("chamados")
      .insert({
        unidade_id: unidadeLocal.id,
        tipo_atendimento: "dfcom",
        status: "em_fila",
        telefone: phone,
        franqueado_nome: unidadeExterna.grupo,
        atendente_nome: atendenteDFCom.nome,
        atendente_id: atendenteDFCom.id,
        descricao: "Solicita√ß√£o de suporte t√©cnico via DFCom",
        categoria: "suporte_tecnico",
        prioridade: "normal",
      })
      .select()
      .single();

    if (chamadoError) {
      console.error("‚ùå Erro ao criar chamado DFCom:", chamadoError);
      return new Response(JSON.stringify({ error: "Falha ao criar chamado DFCom" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 500,
      });
    }
    console.log("üé´ Chamado DFCom criado:", chamado);

    // 6. Calcular posi√ß√£o na fila GLOBAL da DFCom (todas as unidades)
    const { data: fila, error: filaError } = await supabase
      .from("chamados")
      .select("id, criado_em, status")
      .in("status", ["em_fila", "em_atendimento"])
      .eq("tipo_atendimento", "dfcom")
      .order("criado_em", { ascending: true });

    if (filaError) {
      console.error("‚ùå Erro ao buscar fila DFCom:", filaError);
      return new Response(JSON.stringify({ error: "Erro ao buscar fila DFCom" }), {
        headers: { "Content-Type": "application/json", ...corsHeaders },
        status: 500,
      });
    }

    // Posi√ß√£o na fila GLOBAL (conta em_fila + em_atendimento)
    const posicao = fila.findIndex((c) => c.id === chamado.id) + 1;
    
    console.log(`üìä Fila GLOBAL DFCom: ${fila.length} atendimentos (em_fila + em_atendimento)`);
    console.log(`   - Posi√ß√£o deste chamado: #${posicao}`);

    // 4. Log do chamado criado (grupo ser√° adicionado quando atendente aceitar)
    console.log('üìã Chamado DFCom criado para fila, aguardando atendente aceitar no kanban');

    // Carrega configura√ß√µes Z-API
    const { instanceId, instanceToken, clientToken, baseUrl } = await loadZAPIConfig();
    const zapiUrl = `${baseUrl}/instances/${instanceId}/token/${instanceToken}`;

    async function enviarZapi(endpoint: string, payload: any) {
      try {
        const res = await fetch(`${zapiUrl}/${endpoint}`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Client-Token": clientToken },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        console.log("üì§ Enviado:", endpoint, data);
      } catch (err) {
        console.error("‚ùå Erro ao enviar Z-API:", err);
      }
    }

    // 5. Mensagem com posi√ß√£o na fila
    const mensagem = `üßæ Seu n√∫mero na fila √©: *#${posicao}*\n\nPor favor, permane√ßa aqui. Assim que for sua vez, voc√™ receber√° uma mensagem diretamente por aqui.\n\nSe desejar encerrar o atendimento ou alterar a maneira de atendimento para autoatendimento, selecione um dos bot√µes abaixo:`;

    if (!silentMode) {
      await enviarZapi("send-button-list", {
        phone,
        message: mensagem,
        buttonList: {
          buttons: [
            { id: "personalizado_finalizar", label: "‚úÖ Finalizar atendimento" },
            { id: "autoatendimento_menu", label: "üîÑ Transferir para autoatendimento" },
          ],
        },
      });
    }

    return new Response(JSON.stringify({ 
      success: true, 
      chamado, 
      posicao,
      mensagem_gerada: mensagem 
    }), {
      headers: { "Content-Type": "application/json", ...corsHeaders },
      status: 200,
    });
  } catch (err) {
    console.error("‚ùå Erro interno:", err);
    return new Response(JSON.stringify({ error: err.message }), {
      headers: { "Content-Type": "application/json", ...corsHeaders },
      status: 500,
    });
  }
});